name: Deploy para VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: Deploy para VPS
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar depend√™ncias
        run: npm ci

      - name: Gerar cliente Prisma
        run: npm run db:generate
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Configurar SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Adicionar servidor ao known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Criar diret√≥rio de deploy na VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            mkdir -p ${{ secrets.VPS_DEPLOY_PATH }}/releases
            mkdir -p ${{ secrets.VPS_DEPLOY_PATH }}/shared
          ENDSSH

      - name: Criar arquivo de release
        run: |
          RELEASE_DIR="${{ secrets.VPS_DEPLOY_PATH }}/releases/$(date +%Y%m%d_%H%M%S)"
          echo "RELEASE_DIR=$RELEASE_DIR" >> $GITHUB_ENV

      - name: Fazer backup do banco de dados
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << ENDSSH
            cd ${{ secrets.VPS_DEPLOY_PATH }}
            if [ -f scripts/vps/backup-banco.sh ]; then
              bash scripts/vps/backup-banco.sh || true
            fi
          ENDSSH

      - name: Sincronizar c√≥digo para VPS
        run: |
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.git' \
            --exclude 'logs' \
            --exclude 'backups' \
            --exclude '.env*' \
            --exclude '*.log' \
            --exclude 'mobile' \
            --exclude 'mobile-expo-temp' \
            --exclude 'ekklesia-build-temp' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_DEPLOY_PATH }}/

      - name: Atualizar arquivo .env.production na VPS (preservando vari√°veis existentes)
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ secrets.VPS_DEPLOY_PATH }}
            
            # Fazer backup do arquivo existente se houver
            if [ -f .env.production ]; then
              cp .env.production .env.production.backup.$(date +%Y%m%d_%H%M%S)
              echo "üì¶ Backup do .env.production criado"
            fi
            
            # Criar arquivo tempor√°rio com vari√°veis dos secrets
            cat > .env.production.new << 'ENVFILE'
          NODE_ENV=production
          DATABASE_URL="${{ secrets.DATABASE_URL }}"
          JWT_SECRET="${{ secrets.JWT_SECRET }}"
          JWT_EXPIRES_IN=7d
          NEXTAUTH_URL="${{ secrets.NEXTAUTH_URL }}"
          NEXTAUTH_SECRET="${{ secrets.NEXTAUTH_SECRET }}"
          APP_URL="${{ secrets.APP_URL }}"
          ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}"
          ALLOWED_ORIGINS="${{ secrets.ALLOWED_ORIGINS }}"
          ENVFILE
            
            # Se j√° existe .env.production, fazer merge preservando vari√°veis customizadas
            if [ -f .env.production ]; then
              echo "üîÑ Fazendo merge com vari√°veis existentes..."
              
              # Extrair vari√°veis dos secrets (chaves conhecidas)
              SECRET_VARS="NODE_ENV|DATABASE_URL|JWT_SECRET|JWT_EXPIRES_IN|NEXTAUTH_URL|NEXTAUTH_SECRET|APP_URL|ENCRYPTION_KEY|ALLOWED_ORIGINS"
              
              # Preservar vari√°veis customizadas que n√£o est√£o nos secrets
              grep -vE "^($SECRET_VARS)=" .env.production | grep -v "^#" | grep -v "^$" > .env.custom || true
              
              # Combinar: vari√°veis dos secrets + vari√°veis customizadas preservadas
              cat .env.production.new > .env.production
              if [ -s .env.custom ]; then
                echo "" >> .env.production
                echo "# Vari√°veis customizadas preservadas do deploy anterior" >> .env.production
                cat .env.custom >> .env.production
                echo "‚úÖ Vari√°veis customizadas preservadas"
              fi
              
              rm -f .env.production.new .env.custom
              echo "‚úÖ Arquivo .env.production atualizado (vari√°veis dos secrets + customizadas preservadas)"
            else
              # Se n√£o existe, criar novo arquivo
              mv .env.production.new .env.production
              echo "‚úÖ Arquivo .env.production criado pela primeira vez"
            fi
            
            chmod 600 .env.production
            echo "‚úÖ Permiss√µes do .env.production configuradas"
          EOF

      - name: Deploy na VPS
        run: |
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.VPS_DEPLOY_PATH }}
            
            echo "üöÄ Iniciando deploy..."
            
            # Remover diret√≥rios que n√£o devem estar na VPS
            echo "üßπ Removendo diret√≥rios desnecess√°rios..."
            rm -rf mobile mobile-expo-temp ekklesia-build-temp 2>/dev/null || true
            echo "‚úÖ Diret√≥rios mobile removidos (se existiam)"
            
            # Sincronizar .env com .env.production (preservando .env se n√£o houver .env.production)
            if [ -f .env.production ]; then
              # Fazer backup do .env atual se existir
              if [ -f .env ]; then
                cp .env .env.backup.$(date +%Y%m%d_%H%M%S) || true
              fi
              cp .env.production .env
              echo "‚úÖ Arquivo .env sincronizado com .env.production"
            elif [ -f .env ]; then
              # Se n√£o houver .env.production mas houver .env, preservar .env
              echo "‚ö†Ô∏è  Arquivo .env.production n√£o encontrado, usando .env existente"
            else
              echo "‚ùå Nenhum arquivo de ambiente encontrado (.env ou .env.production)!"
              echo "üí° Configure as vari√°veis de ambiente antes de continuar."
              exit 1
            fi
            
            # Instalar depend√™ncias
            echo "üì¶ Instalando depend√™ncias..."
            npm ci --production=false
            
            # Gerar cliente Prisma
            echo "üîß Gerando cliente Prisma..."
            npx prisma generate
            
            # Executar migra√ß√µes
            echo "üóÑÔ∏è  Executando migra√ß√µes..."
            npx prisma migrate deploy || echo "‚ö†Ô∏è  Migra√ß√µes podem ter falhado (normal se j√° aplicadas)"
            
            # Build da aplica√ß√£o
            echo "üèóÔ∏è  Fazendo build..."
            npm run build
            
            # Reiniciar aplica√ß√£o com PM2
            echo "üîÑ Reiniciando aplica√ß√£o..."
            if pm2 list | grep -q "ekklesia"; then
              pm2 restart ekklesia
            else
              # Usar ecosystem.config.js se existir, sen√£o usar npm start
              if [ -f ecosystem.config.js ]; then
                pm2 start ecosystem.config.js
              else
                pm2 start npm --name "ekklesia" -- start
              fi
              pm2 save
            fi
            
            echo "‚úÖ Deploy conclu√≠do!"
          ENDSSH

      - name: Verificar deploy
        run: |
          sleep 5
          ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
            # Verificar se PM2 est√° rodando
            if pm2 list | grep -q "ekklesia.*online"; then
              echo "‚úÖ Aplica√ß√£o est√° rodando no PM2"
              pm2 status
            else
              echo "‚ùå Aplica√ß√£o n√£o est√° rodando"
              pm2 logs ekklesia --lines 50
              exit 1
            fi
            
            # Testar endpoint local
            if curl -f http://localhost:3000 > /dev/null 2>&1; then
              echo "‚úÖ Aplica√ß√£o respondendo na porta 3000"
            else
              echo "‚ö†Ô∏è  Aplica√ß√£o n√£o est√° respondendo na porta 3000"
            fi
          ENDSSH

      - name: Notificar sucesso
        if: success()
        run: |
          echo "üéâ Deploy conclu√≠do com sucesso!"
          echo "Aplica√ß√£o dispon√≠vel em: ${{ secrets.APP_URL }}"

      - name: Notificar falha
        if: failure()
        run: |
          echo "‚ùå Deploy falhou!"
          echo "Verifique os logs acima para mais detalhes."

